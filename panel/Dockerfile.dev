# Development Dockerfile with hot reload
FROM node:25-alpine

RUN npm install -g pnpm

# Install docker CLI and tzdata for timezone support
RUN apk add --no-cache docker-cli docker-cli-compose tzdata

WORKDIR /app

# Install root dependencies
COPY package.json ./
RUN pnpm install

# Install backend dependencies
COPY backend/package.json backend/pnpm-lock.yaml* ./backend/
RUN cd backend && pnpm install

# Install frontend dependencies
COPY frontend/package.json frontend/pnpm-lock.yaml* ./frontend/
RUN cd frontend && pnpm install

# Copy shared config
COPY tsconfig.base.json biome.json ./

# Copy source files (NOT node_modules - those stay from pnpm install)
COPY backend/src ./backend/src
COPY backend/tsconfig*.json ./backend/
COPY backend/jest.config.js ./backend/
COPY frontend/src ./frontend/src
COPY frontend/public ./frontend/public
COPY frontend/*.html ./frontend/
COPY frontend/*.config.* ./frontend/
COPY frontend/tsconfig.json ./frontend/

# Create data directory for multi-server persistence
RUN mkdir -p /opt/hytale-panel/data/servers

ENV DATA_PATH=/opt/hytale-panel/data
EXPOSE 3000 5173

# Start both backend and frontend dev servers
CMD ["pnpm", "dev"]
